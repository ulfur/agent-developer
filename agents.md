# Agent Operating Instructions

## Mission Context
- Maintain an agent-enabled development host that can accept prompts from the web UI and run them on this very codebase.
- Keep the frontend (Vue3 + Vuetify) and backend (Python standard library server) operational on a Raspberry Pi 5 running Pi OS Lite or any similar headless target.

## Workflow Expectations
1. Read `the_project.txt` for high-level goals and `README.md` for the current architecture before starting any task.
2. Log each prompt's intent, actions, and results to `logs/progress.log` and the per-prompt log file generated by the backend.
3. Prefer incremental changes with frequent verification steps (unit tests, lint, smoke tests). Document any skipped checks and why.
4. When network access is required (package installs, external APIs), call that out explicitly and wait for approval if needed.
5. Failed prompts remain in the queue; trigger a retry via the UI button or `POST /api/prompts/<id>/retry` after diagnosing the issue.
6. The backend normally runs as the `agent-dev-host.service` user unit (`systemctl --user start|stop|status agent-dev-host.service`). Update `~/.config/systemd/user/agent-dev-host.env` if you need to change Codex, sandbox, or e-ink settings (including `EINK_ROTATE`) and run `systemctl --user daemon-reload` afterward.
7. Keep instructions in this file up to date as the workflow evolves.

## Tooling Available
- Python 3.13 standard library.
- Custom backend server at `backend/server.py` with REST API endpoints under `/api` and a WebSocket endpoint at `/ws` for realtime updates/streaming.
- Frontend UI served from `frontend/index.html` using Vue/Vuetify via CDN.
- Data persistence under `data/` and logs under `logs/`.
- Git is available for change tracking.

## Response Style
- Prioritize narrating the thought process and decision-making; keep answers short and structured around reasoning rather than implementation dumps.
- Reference files, functions, and line numbers verbally instead of pasting large code blocks or diffs. Only include a tiny snippet when it is absolutely critical to understand the reasoning.
- Summarize changes and verification steps plainly (e.g., "Updated `frontend/index.html` to collapse code blocks") so reviewers can jump into the repo for details.
- Call out skipped checks/tests explicitly, but keep the explanation concise.

## Logging Conventions
- `logs/progress.log` is the rolling operational log; include timestamped entries for server start/stop, prompt transitions, and noteworthy results.
- Each prompt writes to `logs/prompt_<id>.log` for replayable execution detail.
- `logs/backend.stdout.log` / `logs/backend.stderr.log` capture the systemd unit’s console output; `journalctl --user -u agent-dev-host.service -f` tails the same stream.

## Realtime + streaming details
- Web clients connect to `/ws`, authenticate by sending `{type: "auth", token: <JWT>}`, and stay subscribed to `queue_snapshot`, `prompt_update`, `health`, and `prompt_stream` events.
- `CodexRunner` streams stdout/stderr chunks while the CLI runs; each chunk is tagged with the prompt id so the UI can append it live. Always restart the service after changing streaming logic.
- If the socket drops, the frontend falls back to REST (`/api/prompts`) but reconnects with exponential backoff. Keep the server loop tolerant of idle sockets (no per-second crash loops).
- When adding new realtime payloads, update both `EventStreamer` on the backend and `handleRealtimeMessage` on the frontend so messages are recognized.

## Display orientation
- The IT8591/IT8951 status console now defaults to a 180° rotation. Override with `EINK_ROTATE` (0/90/180/270) in the env file, then run `systemctl --user daemon-reload && systemctl --user restart agent-dev-host.service`.

## Response style
- Keep frontend-visible agent replies short and reference files/sections instead of pasting large code blocks. Summaries + file paths are preferred over inline diffs.
- Mention skipped tests or outstanding work explicitly, but limit the reasoning to a few sentences so the UI stays readable.
- When a change requires detailed code context, link to the file and describe the change verbally instead of embedding the full patch.

## Future Enhancements (running backlog)
- Replace the placeholder Codex runner with the actual CLI once available; configure via the `CODEX_CLI` environment variable.
- Add persistent queueing beyond the in-memory structure (e.g., SQLite or Redis) for resilience.
- Expand the WebSocket tooling with per-user filtering and richer event schemas.
- Build authentication and role-based access controls before exposing the service on untrusted networks.
